@page "/"
@rendermode InteractiveServer
@using FriendsOfAward_KrezicGruberSekeric.Components.Viewmodel
@inject NavigationManager navMgr
@inject MyCustomAuthStateProvider MyAuthProvider

<div class="login-page">
    <div class="login-card">
        <h2>Admin Login</h2>
        <p class="subtitle">Bitte melde dich an</p>

        <div class="form-group">
            <label for="username">Benutzername</label>
            <input id="username" @bind="username" placeholder="E-Mail eingeben" />
        </div>

        <div class="form-group">
            <label for="password">Passwort</label>
            <input id="password" type="password" @bind="password" placeholder="Passwort eingeben" />
        </div>

        <button class="login-btn" @onclick="Authenticate">
            Anmelden
        </button>

        @if (!string.IsNullOrEmpty(errormessage))
        {
            <p class="error">@errormessage</p>
        }
    </div>
</div>

@code {
    string username = "";
    string password = "";
    string errormessage = "";

    async Task Authenticate()
    {
        if (IsValidUser(username, password))
        {
            await MyAuthProvider.Login(username);
            navMgr.NavigateTo("/admin", forceLoad: true);
        }
        else
        {
            errormessage = "Ungültiger Benutzername oder Passwort.";
        }
    }

    bool IsValidUser(string username, string password)
    {
        var wrappr = Custom_Library.DbWrapperMySqlV2.Wrapper;
        try
        {
            string sqlCmd = $"SELECT email FROM foa_admin WHERE email = '{username}' AND passwort = '{password}'";
            var dt = wrappr.RunQuery(sqlCmd);
            return dt.Rows.Count > 0;
        }
        catch (Exception ex)
        {
            errormessage = ex.Message;
            return false;
        }
    }
}
