@page "/login"
@rendermode InteractiveServer
@using FriendsOfAward_KrezicGruberSekeric.Components.Viewmodel
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@inject NavigationManager navMgr
@inject MyCustomAuthStateProvider MyAuthProvider

<form @onsubmit="Authenticate" @onsubmit:preventDefault>
    <div>
        <label>Benutzername:</label>
        <input @bind="username" />
    </div>

    <div>
        <label>Passwort:</label>
        <input type="password" @bind="password" />
    </div>

    <button type="submit">Login</button>
</form>

@if (!string.IsNullOrEmpty(errormessage))
{
    <p style="color:red">@errormessage</p>
}

@code {
    string username = "";
    string password = "";
    string errormessage = "";

    void Authenticate()
    {
        if (IsValidUser(username, password))
        {
            MyAuthProvider.Login(username);
            navMgr.NavigateTo("/admin");
        }
        else
        {
            errormessage = "Ungültiger Benutzername oder Passwort.";
        }
    }

    bool IsValidUser(string username, string password)
    {
        try
        {
            var wrappr = Custom_Library.DbWrapperMySqlV2.Wrapper;
            string sqlCmd =
                $"SELECT email FROM foa_admin WHERE email = '{username}' AND passwort = '{password}'";

            var dt = wrappr.RunQuery(sqlCmd);
            return dt.Rows.Count > 0;
        }
        catch (Exception ex)
        {
            errormessage = ex.Message;
            return false;
        }
    }
}
