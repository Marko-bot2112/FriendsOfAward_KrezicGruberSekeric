@page "/admin"
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject Blazored.Toast.Services.IToastService toastService
@inject NavigationManager NavMgr
@using FriendsOfAward_KrezicGruberSekeric.Components.Pages.Account
@using Microsoft.AspNetCore.Components.Authorization
@using ClosedXML.Excel
@using MySql.Data.MySqlClient

<BlazoredToasts></BlazoredToasts>
<AuthorizeView>
    <Authorized>
        <div class="admin-grid">

            <div class="admin-tile blue" @onclick="() => SelectSection(AdminSection.Vote)">
                <h2>Abstimmung</h2>
                <p>Starten / Stoppen / Zurücksetzen</p>
            </div>

            <div class="admin-tile green" @onclick="() => SelectSection(AdminSection.QR)">
                <h2>QR-Codes</h2>
                <p>Codes generieren</p>
            </div>

            <div class="admin-tile orange" @onclick="() => SelectSection(AdminSection.Excel)">
                <h2>Excel Export</h2>
                <p>Export Optionen</p>
            </div>

            <div class="admin-tile red" @onclick="() => SelectSection(AdminSection.Security)">
                <h2>Sicherheit</h2>
                <p>Passwort ändern</p>
            </div>

        </div>
    </Authorized>
    <NotAuthorized>
        <p>Bitte loggen Sie sich ein:</p>
        <button @onclick="Btn_Login">Einloggen</button>
    </NotAuthorized>
</AuthorizeView>

@if (activeSection != AdminSection.None)
{
    <div class="admin-content">

        <h2 class="section-title">@GetSectionTitle()</h2>

        <div class="detail-grid">

            @if (activeSection == AdminSection.Vote)
            {
                <div class="detail-card blue">
                    <h3>Abstimmung starten</h3>
                    <p>Öffnet die Abstimmung für alle Teilnehmer.</p>
                    <button class="detail-button" @onclick="btn_startVote">Starten</button>
                </div>

                <div class="detail-card blue">
                    <h3>Abstimmung stoppen</h3>
                    <p>Beendet die laufende Abstimmung.</p>
                    <button class="detail-button" @onclick="btn_stopVote">Stoppen</button>
                </div>

                <div class="detail-card danger">
                    <h3>Alle Bewertungen löschen</h3>
                    <p>⚠️ Diese Aktion kann nicht rückgängig gemacht werden.</p>
                    <button class="detail-button danger" @onclick="btn_deleteAllReviews">
                        Löschen
                    </button>
                </div>
            }

            @if (activeSection == AdminSection.QR)
            {
                <div class="detail-card green">
                    <h3>QR-Codes generieren</h3>
                    <p>Anzahl der zu erstellenden QR-Codes</p>

                    <input class="qr-input"
                           type="number"
                           min="1"
                           @bind="qrCode_count" />

                    <button class="detail-button" @onclick="() => btn_qrcodesgenerate(qrCode_count)">
                        Generieren
                    </button>
                </div>
                        }

            @if (activeSection == AdminSection.Excel)
                        {
                <div class="detail-card orange">
                    <h3>Excel Export</h3>
                    <p>Exportiert alle Daten als Excel-Datei.</p>
                    <button class="detail-button" @onclick="btn_excelExportOptions">
                        Export starten
                    </button>
                </div>
                <div class="detail-card orange">
                    <h3>Excel Export</h3>
                    <p>Importieren von Excel Datei aller Diplomarbeiten.</p>
                    <InputFile OnChange="OnFileSelected"
                               accept=".xlsx,.xls" />
                    <button class="detail-button" @onclick="btn_ImportExcel">
                        Importieren Starten
                    </button>
                </div>
            }

            @if (activeSection == AdminSection.Security)
            {
                <div class="detail-card red">
                    <h3>Passwort ändern</h3>
                    <p>Aus Sicherheitsgründen regelmäßig ändern.</p>
                    <button class="detail-button" @onclick="btn_changePassword">
                        Passwort ändern
                    </button>
                </div>
            }
                
        </div>  
    </div>

    @if (rows.Any())
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Nr</th>
                    <th>Abteilung</th>
                    <th>Titel</th>
                    <th>Autor</th>
                    <th>Stimmen</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in daten)
                {
                    <tr>
                        <td>@d.Nr</td>
                        <td>@d.Abteilung</td>
                        <td>@d.Titel</td>
                        <td>@d.Autor</td>
                        <td>@d.Stimmen</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
@code {

    private List<DiplomarbeitenDto> daten = new();

    private int qrCode_count = 1;

    private AdminSection activeSection = AdminSection.None;

    private void SelectSection(AdminSection section)
    {
        activeSection = section;
    }

    private string GetSectionTitle() => activeSection switch
    {
        AdminSection.Vote => "Abstimmung verwalten",
        AdminSection.QR => "QR-Codes",
        AdminSection.Excel => "Excel Export",
        AdminSection.Security => "Sicherheit",
        _ => ""
    };

    enum AdminSection
    {
        None,
        Vote,
        QR,
        Excel,
        Security
    }
    private void Btn_Login()
    {
        NavMgr.NavigateTo("/login");
    }

    private void btn_startVote()
    {
        toastService.ShowInfo("Abstimmumng starten ist noch nicht implementiert.");
    }
    private void btn_stopVote()
    {
        toastService.ShowInfo("Abstimmung stoppen ist noch nicht implementiert.");
    }
    private void btn_deleteAllReviews()
    {
        toastService.ShowWarning("Alle Bewertungen löschen ist noch nicht implementiert.");
    }
    private void btn_changePassword()
    {
        toastService.ShowInfo("Passwort ändern ist noch nicht implementiert.");
    }

    List<string> QrCodeList;
    private async void btn_qrcodesgenerate(int count)
    {
        // 1️⃣ QR-Codes erzeugen
        var qrCodes = GenerateQrCodes(count); // Anzahl beliebig

        // 2️⃣ HTML bauen (DEINE Methode)
        var html = BuildHtml(qrCodes);

        // 3️⃣ Download starten
        await JS.InvokeVoidAsync("downloadHtmlFile", "qrcodes.html", html);
    }
    List<string> GenerateQrCodes(int count)
    {
        var result = new List<string>();

        for (int i = 0; i < count; i++)
        {
            var token = Guid.NewGuid().ToString();
            var payload = $"https://172.17.10.51:5432/validation/{token}";

            using var generator = new QRCoder.QRCodeGenerator();
            using var data = generator.CreateQrCode(payload, QRCoder.QRCodeGenerator.ECCLevel.Q);
            using var qrCode = new QRCoder.PngByteQRCode(data);

            var bytes = qrCode.GetGraphic(20);
            var base64 = Convert.ToBase64String(bytes);

            result.Add($"data:image/png;base64,{base64}");
        }

        return result;
    }
    string BuildHtml(List<string> qrCodes)
    {
        var sb = new System.Text.StringBuilder();

        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html lang=\"de\">");
        sb.AppendLine("<head>");
        sb.AppendLine("  <meta charset=\"UTF-8\">");
        sb.AppendLine("  <title>QR Codes</title>");
        sb.AppendLine("  <style>");
        sb.AppendLine("    body { font-family: Arial; text-align: center; margin-top: 40px; }");
        sb.AppendLine("    img { width: 300px; height: 300px; }");
        sb.AppendLine("    button { padding: 10px 20px; margin: 10px; font-size: 16px; }");
        sb.AppendLine("  </style>");
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");

        sb.AppendLine($"  <h2>QR Code <span id=\"index\">1</span> / {qrCodes.Count}</h2>");
        sb.AppendLine("  <img id=\"qrImage\" src=\"\" />");

        sb.AppendLine("  <div>");
        sb.AppendLine("    <button onclick=\"prev()\">⬅ Vorher</button>");
        sb.AppendLine("    <button onclick=\"next()\">Nachher ➡</button>");
        sb.AppendLine("  </div>");

        // --- JavaScript ---
        sb.AppendLine("  <script>");
        sb.AppendLine("    const images = [");

        for (int i = 0; i < qrCodes.Count; i++)
        {
            var comma = i < qrCodes.Count - 1 ? "," : "";
            sb.AppendLine($"      \"{qrCodes[i]}\"{comma}");
        }

        sb.AppendLine("    ];");
        sb.AppendLine("    let current = 0;");
        sb.AppendLine("    const img = document.getElementById(\"qrImage\");");
        sb.AppendLine("    const indexLabel = document.getElementById(\"index\");");

        sb.AppendLine("    function update() {");
        sb.AppendLine("      img.src = images[current];");
        sb.AppendLine("      indexLabel.innerText = current + 1;");
        sb.AppendLine("    }");

        sb.AppendLine("    function next() {");
        sb.AppendLine("      if (current < images.length - 1) { current++; update(); }");
        sb.AppendLine("    }");

        sb.AppendLine("    function prev() {");
        sb.AppendLine("      if (current > 0) { current--; update(); }");
        sb.AppendLine("    }");

        sb.AppendLine("    update();");
        sb.AppendLine("  </script>");

        sb.AppendLine("</body>");
        sb.AppendLine("</html>");

        return sb.ToString();
    }


    private List<List<string>> rows = new();

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        daten.Clear();
        rows.Clear();

        IBrowserFile file = e.File;

        var extension = Path.GetExtension(file.Name).ToLower();
        if (extension != ".xlsx" && extension != ".xls" && extension != ".xlsm")
        {
            toastService.ShowError("Keine Excel-Datei!");
            return;
        }

        using var stream = file.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        using var workbook = new XLWorkbook(ms);
        var worksheet = workbook.Worksheet(1);

        foreach (var row in worksheet.RowsUsed())
        {
            var dto = new DiplomarbeitenDto
            {
                Nr = row.Cell(1).GetValue<int>(),
                Abteilung = row.Cell(2).GetString(),
                Titel = row.Cell(3).GetString(),
                Autor = row.Cell(4).GetString(),
                Stimmen = row.Cell(5).GetValue<int>()
            };

            daten.Add(dto);

            rows.Add(new List<string>
        {
            dto.Nr.ToString(),
            dto.Abteilung,
            dto.Titel,
            dto.Autor
        });
        }

        toastService.ShowSuccess($"{daten.Count} Zeilen geladen.");
    }
    private void btn_ImportExcel()
    {
        if (!daten.Any())
        {
            toastService.ShowWarning("Keine Daten zum Importieren!");
            return;
        }

        string error = "";
        DbWrapperMySqlV2 wrappr = DbWrapperMySqlV2.Wrapper;
        try
        {
            foreach (var item in daten)
            {
                string abteilung = MySqlHelper.EscapeString(item.Abteilung);
                string titel = MySqlHelper.EscapeString(item.Titel);
                string autor = MySqlHelper.EscapeString(item.Autor);                
                string sql = $"INSERT INTO foa_diplomarbeiten VALUES ('{item.Nr}', '{abteilung}', '{titel}', '{autor}', '{item.Stimmen}')";


                wrappr.RunNonQuery(sql);
            }
            toastService.ShowSuccess("Excel-Daten erfolgreich importiert!");
        }
        catch (Exception ex)
        {
            toastService.ShowError("Fehler beim Import: " + ex.Message);
        }

    }

    private void btn_excelExportOptions() 
    {
    
    }

}
